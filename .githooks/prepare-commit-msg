#!/bin/bash

# Git hook to help with commit message formatting
# Prepopulates commit message with US-<number> based on branch name

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only run for regular commits (not merge, squash, etc.)
if [ -n "$COMMIT_SOURCE" ]; then
    exit 0
fi

# Get current branch name
BRANCH=$(git branch --show-current)

# Extract issue number from branch name (e.g., feature/us-1-device-types -> 1)
if [[ "$BRANCH" =~ us-([0-9]+) ]]; then
    ISSUE_NUM="${BASH_REMATCH[1]}"
    
    # Check if commit message is empty or just the default template
    CURRENT_MSG=$(cat "$COMMIT_MSG_FILE" | grep -v '^#')
    
    if [ -z "$CURRENT_MSG" ] || [[ "$CURRENT_MSG" =~ ^US-\<issue-number\> ]]; then
        # Prepopulate with the issue number from the branch
        echo "US-$ISSUE_NUM: " > "$COMMIT_MSG_FILE"
        echo "" >> "$COMMIT_MSG_FILE"
        echo "# Working on issue #$ISSUE_NUM" >> "$COMMIT_MSG_FILE"
        echo "# Remember: End with #$ISSUE_NUM for GitHub linking" >> "$COMMIT_MSG_FILE"
        echo "# Remember: Use imperative mood (Add, not Added)" >> "$COMMIT_MSG_FILE"
        cat .gitmessage | tail -n +4 >> "$COMMIT_MSG_FILE"
    fi
fi
