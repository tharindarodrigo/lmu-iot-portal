#!/bin/bash

# Git hook to validate commit message format
# This ensures commits follow the US-<number>: format

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if it's a merge commit
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Skip if commit message is empty or just comments
if [[ -z "$(echo "$COMMIT_MSG" | grep -v '^#')" ]]; then
    exit 0
fi

# Check if message follows US-<number>: format
if ! [[ "$COMMIT_MSG" =~ ^US-[0-9]+:\ .+ ]]; then
    echo ""
    echo "❌ Invalid commit message format!"
    echo ""
    echo "Your message:"
    echo "  $COMMIT_MSG"
    echo ""
    echo "Required format:"
    echo "  US-<issue-number>: <description>"
    echo ""
    echo "Examples:"
    echo "  US-1: Add ProtocolType enum"
    echo "  US-7: Create parameter validation logic"
    echo ""
    echo "See CONTRIBUTING.md for details"
    echo ""
    exit 1
fi

# Extract issue number from commit message (macOS compatible)
if [[ "$COMMIT_MSG" =~ US-([0-9]+) ]]; then
    ISSUE_NUM="${BASH_REMATCH[1]}"
else
    # This shouldn't happen since we already validated the format, but just in case
    exit 0
fi

# Get current branch name
BRANCH=$(git branch --show-current)

# Check if branch contains us-<number>
if [[ "$BRANCH" =~ us-([0-9]+) ]]; then
    BRANCH_ISSUE="${BASH_REMATCH[1]}"
    
    # Warn if commit issue number doesn't match branch issue number
    if [ "$ISSUE_NUM" != "$BRANCH_ISSUE" ]; then
        echo ""
        echo "⚠️  WARNING: Commit references US-$ISSUE_NUM but branch is for US-$BRANCH_ISSUE"
        echo ""
        read -p "Continue anyway? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

exit 0
